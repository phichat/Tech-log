/**
 * @fileoverview Prevent missing parentheses around multilines JSX
 * @author Yannick Croissant
 */
'use strict';

<<<<<<< HEAD
=======
var has = require('has');

>>>>>>> 09665636ba9818fc952cd8bfe693d791912356d2
// ------------------------------------------------------------------------------
// Constants
// ------------------------------------------------------------------------------

var DEFAULTS = {
  declaration: true,
  assignment: true,
<<<<<<< HEAD
  return: true
=======
  return: true,
  arrow: true
>>>>>>> 09665636ba9818fc952cd8bfe693d791912356d2
};

// ------------------------------------------------------------------------------
// Rule Definition
// ------------------------------------------------------------------------------

module.exports = {
  meta: {
    docs: {
      description: 'Prevent missing parentheses around multilines JSX',
      category: 'Stylistic Issues',
      recommended: false
    },
    fixable: 'code',

    schema: [{
      type: 'object',
      properties: {
        declaration: {
          type: 'boolean'
        },
        assignment: {
          type: 'boolean'
        },
        return: {
          type: 'boolean'
<<<<<<< HEAD
=======
        },
        arrow: {
          type: 'boolean'
>>>>>>> 09665636ba9818fc952cd8bfe693d791912356d2
        }
      },
      additionalProperties: false
    }]
  },

  create: function(context) {

    var sourceCode = context.getSourceCode();

    function isParenthesised(node) {
      var previousToken = sourceCode.getTokenBefore(node);
      var nextToken = sourceCode.getTokenAfter(node);

      return previousToken && nextToken &&
        previousToken.value === '(' && previousToken.range[1] <= node.range[0] &&
        nextToken.value === ')' && nextToken.range[0] >= node.range[1];
    }

    function isMultilines(node) {
      return node.loc.start.line !== node.loc.end.line;
    }

    function check(node) {
      if (!node || node.type !== 'JSXElement') {
        return;
      }

      if (!isParenthesised(node) && isMultilines(node)) {
        context.report({
          node: node,
          message: 'Missing parentheses around multilines JSX',
          fix: function(fixer) {
<<<<<<< HEAD
            return fixer.replaceText(node, '(' + sourceCode.getText(node) + ')');
=======
            return fixer.replaceText(node, `(${sourceCode.getText(node)})`);
>>>>>>> 09665636ba9818fc952cd8bfe693d791912356d2
          }
        });
      }
    }

    function isEnabled(type) {
      var userOptions = context.options[0] || {};
<<<<<<< HEAD
      if (({}).hasOwnProperty.call(userOptions, type)) {
=======
      if (has(userOptions, type)) {
>>>>>>> 09665636ba9818fc952cd8bfe693d791912356d2
        return userOptions[type];
      }
      return DEFAULTS[type];
    }

    // --------------------------------------------------------------------------
    // Public
    // --------------------------------------------------------------------------

    return {

      VariableDeclarator: function(node) {
<<<<<<< HEAD
        if (isEnabled('declaration')) {
          check(node.init);
        }
      },

      AssignmentExpression: function(node) {
        if (isEnabled('assignment')) {
          check(node.right);
        }
=======
        if (!isEnabled('declaration')) {
          return;
        }
        if (node.init && node.init.type === 'ConditionalExpression') {
          check(node.init.consequent);
          check(node.init.alternate);
          return;
        }
        check(node.init);
      },

      AssignmentExpression: function(node) {
        if (!isEnabled('assignment')) {
          return;
        }
        if (node.right.type === 'ConditionalExpression') {
          check(node.right.consequent);
          check(node.right.alternate);
          return;
        }
        check(node.right);
>>>>>>> 09665636ba9818fc952cd8bfe693d791912356d2
      },

      ReturnStatement: function(node) {
        if (isEnabled('return')) {
          check(node.argument);
        }
<<<<<<< HEAD
=======
      },

      'ArrowFunctionExpression:exit': function (node) {
        var arrowBody = node.body;

        if (isEnabled('arrow') && arrowBody.type !== 'BlockStatement') {
          check(arrowBody);
        }
>>>>>>> 09665636ba9818fc952cd8bfe693d791912356d2
      }
    };

  }
};
