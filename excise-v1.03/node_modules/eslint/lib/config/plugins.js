/**
 * @fileoverview Plugins manager
 * @author Nicholas C. Zakas
 */
"use strict";

//------------------------------------------------------------------------------
// Requirements
//------------------------------------------------------------------------------

<<<<<<< HEAD
const Environments = require("./environments"),
    Rules = require("../rules");

=======
>>>>>>> 09665636ba9818fc952cd8bfe693d791912356d2
const debug = require("debug")("eslint:plugins");

//------------------------------------------------------------------------------
// Private
//------------------------------------------------------------------------------

<<<<<<< HEAD
let plugins = Object.create(null);

const PLUGIN_NAME_PREFIX = "eslint-plugin-",
    NAMESPACE_REGEX = /^@.*\//i;

/**
 * Removes the prefix `eslint-plugin-` from a plugin name.
 * @param {string} pluginName The name of the plugin which may have the prefix.
 * @returns {string} The name of the plugin without prefix.
 */
function removePrefix(pluginName) {
    return pluginName.indexOf(PLUGIN_NAME_PREFIX) === 0 ? pluginName.substring(PLUGIN_NAME_PREFIX.length) : pluginName;
}

/**
 * Gets the scope (namespace) of a plugin.
 * @param {string} pluginName The name of the plugin which may have the prefix.
 * @returns {string} The name of the plugins namepace if it has one.
 */
function getNamespace(pluginName) {
    return pluginName.match(NAMESPACE_REGEX) ? pluginName.match(NAMESPACE_REGEX)[0] : "";
}

/**
 * Removes the namespace from a plugin name.
 * @param {string} pluginName The name of the plugin which may have the prefix.
 * @returns {string} The name of the plugin without the namespace.
 */
function removeNamespace(pluginName) {
    return pluginName.replace(NAMESPACE_REGEX, "");
}

//------------------------------------------------------------------------------
// Public Interface
//------------------------------------------------------------------------------

module.exports = {

    removePrefix,
    getNamespace,
    removeNamespace,
=======
const PLUGIN_NAME_PREFIX = "eslint-plugin-",
    NAMESPACE_REGEX = /^@.*\//i;

//------------------------------------------------------------------------------
// Public Interface
//------------------------------------------------------------------------------

/**
 * Plugin class
 */
class Plugins {

    /**
     * Creates the plugins context
     * @param {Environments} envContext - env context
     * @param {Rules} rulesContext - rules context
     */
    constructor(envContext, rulesContext) {
        this._plugins = Object.create(null);
        this._environments = envContext;
        this._rules = rulesContext;
    }

    /**
     * Removes the prefix `eslint-plugin-` from a plugin name.
     * @param {string} pluginName The name of the plugin which may have the prefix.
     * @returns {string} The name of the plugin without prefix.
     */
    static removePrefix(pluginName) {
        return pluginName.startsWith(PLUGIN_NAME_PREFIX) ? pluginName.substring(PLUGIN_NAME_PREFIX.length) : pluginName;
    }

    /**
     * Gets the scope (namespace) of a plugin.
     * @param {string} pluginName The name of the plugin which may have the prefix.
     * @returns {string} The name of the plugins namepace if it has one.
     */
    static getNamespace(pluginName) {
        return pluginName.match(NAMESPACE_REGEX) ? pluginName.match(NAMESPACE_REGEX)[0] : "";
    }

    /**
     * Removes the namespace from a plugin name.
     * @param {string} pluginName The name of the plugin which may have the prefix.
     * @returns {string} The name of the plugin without the namespace.
     */
    static removeNamespace(pluginName) {
        return pluginName.replace(NAMESPACE_REGEX, "");
    }
>>>>>>> 09665636ba9818fc952cd8bfe693d791912356d2

    /**
     * Defines a plugin with a given name rather than loading from disk.
     * @param {string} pluginName The name of the plugin to load.
     * @param {Object} plugin The plugin object.
     * @returns {void}
     */
    define(pluginName, plugin) {
<<<<<<< HEAD
        const pluginNamespace = getNamespace(pluginName),
            pluginNameWithoutNamespace = removeNamespace(pluginName),
            pluginNameWithoutPrefix = removePrefix(pluginNameWithoutNamespace),
            shortName = pluginNamespace + pluginNameWithoutPrefix;

        // load up environments and rules
        plugins[shortName] = plugin;
        Environments.importPlugin(plugin, shortName);
        Rules.importPlugin(plugin, shortName);

        // load up environments and rules for the name that '@scope/' was omitted
        // 3 lines below will be removed by 4.0.0
        plugins[pluginNameWithoutPrefix] = plugin;
        Environments.importPlugin(plugin, pluginNameWithoutPrefix);
        Rules.importPlugin(plugin, pluginNameWithoutPrefix);
    },
=======
        const pluginNamespace = Plugins.getNamespace(pluginName),
            pluginNameWithoutNamespace = Plugins.removeNamespace(pluginName),
            pluginNameWithoutPrefix = Plugins.removePrefix(pluginNameWithoutNamespace),
            shortName = pluginNamespace + pluginNameWithoutPrefix;

        // load up environments and rules
        this._plugins[shortName] = plugin;
        this._environments.importPlugin(plugin, shortName);
        this._rules.importPlugin(plugin, shortName);
    }
>>>>>>> 09665636ba9818fc952cd8bfe693d791912356d2

    /**
     * Gets a plugin with the given name.
     * @param {string} pluginName The name of the plugin to retrieve.
     * @returns {Object} The plugin or null if not loaded.
     */
    get(pluginName) {
<<<<<<< HEAD
        return plugins[pluginName] || null;
    },
=======
        return this._plugins[pluginName] || null;
    }
>>>>>>> 09665636ba9818fc952cd8bfe693d791912356d2

    /**
     * Returns all plugins that are loaded.
     * @returns {Object} The plugins cache.
     */
    getAll() {
<<<<<<< HEAD
        return plugins;
    },
=======
        return this._plugins;
    }
>>>>>>> 09665636ba9818fc952cd8bfe693d791912356d2

    /**
     * Loads a plugin with the given name.
     * @param {string} pluginName The name of the plugin to load.
     * @returns {void}
     * @throws {Error} If the plugin cannot be loaded.
     */
    load(pluginName) {
<<<<<<< HEAD
        const pluginNamespace = getNamespace(pluginName),
            pluginNameWithoutNamespace = removeNamespace(pluginName),
            pluginNameWithoutPrefix = removePrefix(pluginNameWithoutNamespace),
=======
        const pluginNamespace = Plugins.getNamespace(pluginName),
            pluginNameWithoutNamespace = Plugins.removeNamespace(pluginName),
            pluginNameWithoutPrefix = Plugins.removePrefix(pluginNameWithoutNamespace),
>>>>>>> 09665636ba9818fc952cd8bfe693d791912356d2
            shortName = pluginNamespace + pluginNameWithoutPrefix,
            longName = pluginNamespace + PLUGIN_NAME_PREFIX + pluginNameWithoutPrefix;
        let plugin = null;

        if (pluginName.match(/\s+/)) {
            const whitespaceError = new Error(`Whitespace found in plugin name '${pluginName}'`);

            whitespaceError.messageTemplate = "whitespace-found";
            whitespaceError.messageData = {
                pluginName: longName
            };
            throw whitespaceError;
        }

<<<<<<< HEAD
        if (!plugins[shortName]) {
            try {
                plugin = require(longName);
            } catch (err) {
                debug(`Failed to load plugin ${longName}.`);
                err.message = `Failed to load plugin ${pluginName}: ${err.message}`;
                err.messageTemplate = "plugin-missing";
                err.messageData = {
                    pluginName: longName
                };
                throw err;
=======
        if (!this._plugins[shortName]) {
            try {
                plugin = require(longName);
            } catch (pluginLoadErr) {
                try {

                    // Check whether the plugin exists
                    require.resolve(longName);
                } catch (missingPluginErr) {

                    // If the plugin can't be resolved, display the missing plugin error (usually a config or install error)
                    debug(`Failed to load plugin ${longName}.`);
                    missingPluginErr.message = `Failed to load plugin ${pluginName}: ${missingPluginErr.message}`;
                    missingPluginErr.messageTemplate = "plugin-missing";
                    missingPluginErr.messageData = {
                        pluginName: longName
                    };
                    throw missingPluginErr;
                }

                // Otherwise, the plugin exists and is throwing on module load for some reason, so print the stack trace.
                throw pluginLoadErr;
>>>>>>> 09665636ba9818fc952cd8bfe693d791912356d2
            }

            this.define(pluginName, plugin);
        }
<<<<<<< HEAD
    },
=======
    }
>>>>>>> 09665636ba9818fc952cd8bfe693d791912356d2

    /**
     * Loads all plugins from an array.
     * @param {string[]} pluginNames An array of plugins names.
     * @returns {void}
     * @throws {Error} If a plugin cannot be loaded.
     */
    loadAll(pluginNames) {
        pluginNames.forEach(this.load, this);
<<<<<<< HEAD
    },

    /**
     * Resets plugin information. Use for tests only.
     * @returns {void}
     */
    testReset() {
        plugins = Object.create(null);
    }
};
=======
    }
}

module.exports = Plugins;
>>>>>>> 09665636ba9818fc952cd8bfe693d791912356d2
